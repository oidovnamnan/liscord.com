# 💰 LISCORD — ТӨЛБӨР ТООЦООНЫ БҮРЭН МОДУЛЬ

> **Зарчим:** Төлбөр тооцоо бол бизнесийн зүрх. Хэзээ, хэнээс, хэдийг, ямар аргаар,
> ямар данс руу авсан/буцаасан — бүгд ил тод, нарийн бүртгэлтэй байх ёстой.

---

## 1. 🏦 ТӨЛБӨРИЙН ДАНС / ХЭТЭВЧ (Payment Accounts)

> Бизнес нь олон данстай байж болно. Төлбөр бүр аль данс руу орсон/гарсныг бүртгэнэ.

### 1.1 Дансны төрлүүд

| # | Төрөл ID | Нэр | Тайлбар | Icon |
|---|----------|-----|---------|------|
| 1 | `cash` | Бэлэн мөнгө | Кассын бэлэн мөнгө | 💵 |
| 2 | `bank_khan` | Хаан банк | Хаан банкны данс | 🏦 |
| 3 | `bank_golomt` | Голомт банк | Голомт банкны данс | 🏦 |
| 4 | `bank_tdb` | ХХБ | Худалдаа хөгжлийн банк | 🏦 |
| 5 | `bank_xac` | Хас банк | Хас банкны данс | 🏦 |
| 6 | `bank_state` | Төрийн банк | Төрийн банкны данс | 🏦 |
| 7 | `bank_other` | Бусад банк | Бусад банкны данс | 🏦 |
| 8 | `qpay` | QPay | QPay хэтэвч | 📱 |
| 9 | `socialpay` | SocialPay | SocialPay хэтэвч | 📱 |
| 10 | `monpay` | MonPay | MonPay хэтэвч | 📱 |
| 11 | `card_pos` | Карт (POS) | POS терминалаар карт | 💳 |
| 12 | `hipay` | HiPay (Хи) | Хи цахим хэтэвч | 📱 |
| 13 | `storepay` | StorePay | StorePay зээл | 📱 |
| 14 | `lendmn` | LendMN | LendMN зээл | 📱 |
| 15 | `wechat` | WeChat Pay | WeChat Pay (Хятад) | 📱 |
| 16 | `other` | Бусад | Бусад арга | 💼 |

### 1.2 Дансны мэдээллийн бүтэц

```javascript
// Firestore: businesses/{bizId}/paymentAccounts/{accountId}
{
  id: "pa_khan_1",
  type: "bank_khan",                    // Дээрх төрлүүдээс
  name: "Хаан банк — Үндсэн данс",     // Хэрэглэгчийн тавьсан нэр
  
  // Дансны мэдээлэл
  details: {
    bankName: "Хаан банк",
    accountNumber: "5000 1234 5678",    // Дансны дугаар
    accountHolder: "Эрээн Карго ХХК",   // Данс эзэмшигчийн нэр
    currency: "MNT",                     // MNT | USD | CNY | KRW | EUR
    
    // QPay/SocialPay/MonPay бол:
    walletId: "",                        // Хэтэвчийн ID
    phoneNumber: "+97699001234",         // Холбоотой утас
    qrCode: "",                          // QR кодын зураг URL
    
    // Карт/POS бол:
    terminalId: "",                      // POS терминалын дугаар
  },
  
  // Төлөв
  isActive: true,
  isDefault: true,                       // Анхдагч данс (төлбөр авахад автомат сонгогдоно)
  
  // Хяналт
  showInReports: true,                   // Тайланд харагдах уу
  allowIncoming: true,                   // Орлого хүлээн авч болох уу
  allowOutgoing: true,                   // Зарлага хийж болох уу (буцаалт гэх мэт)
  
  // Автомат тооцоо (denormalized, transaction-аас тооцоолно)
  balance: {
    current: 5450000,                    // Одоогийн үлдэгдэл (Liscord дээрх)
    lastUpdated: Timestamp
  },
  
  // Мета
  order: 1,                              // Харагдах дараалал
  color: "#FF6B00",                      // UI өнгө
  icon: "🏦",
  createdAt: Timestamp,
  createdBy: "user_xyz"
}
```

### 1.3 Данс тохируулах дэлгэц

```
┌──────────────────────────────────────────┐
│  ⚙️ Тохиргоо > Төлбөрийн данс          │
│                                          │
│  [+ Шинэ данс нэмэх]                    │
│                                          │
│  ── 💵 Бэлэн мөнгө ────────────────── │
│  ┌────────────────────────────────────┐  │
│  │ 💵 Касс                     ★ Анхдагч│
│  │    Үлдэгдэл: ₮2,450,000          │  │
│  │    [✏️ Засах]                      │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ── 🏦 Банкны данс ─────────────────── │
│  ┌────────────────────────────────────┐  │
│  │ 🏦 Хаан банк — Үндсэн данс       │  │
│  │    5000 **** 5678                  │  │
│  │    Эрээн Карго ХХК                │  │
│  │    Үлдэгдэл: ₮12,300,000         │  │
│  │    [✏️] [⛔ Идэвхгүй]            │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 🏦 Голомт банк — Нэмэлт          │  │
│  │    3200 **** 9012                  │  │
│  │    Үлдэгдэл: ₮5,200,000          │  │
│  │    [✏️] [⛔]                      │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ── 📱 Цахим хэтэвч ──────────────── │
│  ┌────────────────────────────────────┐  │
│  │ 📱 QPay                           │  │
│  │    +976 9900 1234                  │  │
│  │    Үлдэгдэл: ₮850,000            │  │
│  │    [✏️] [⛔]                      │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 📱 SocialPay                      │  │
│  │    +976 9900 1234                  │  │
│  │    Үлдэгдэл: ₮400,000            │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ── 💳 POS терминал ──────────────── │
│  ┌────────────────────────────────────┐  │
│  │ 💳 Карт (Хаан банк POS)           │  │
│  │    Терминал: T-001234              │  │
│  │    Үлдэгдэл: ₮1,200,000          │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
```

---

## 2. 💳 ТӨЛБӨР БҮРТГЭХ (Payment Recording)

### 2.1 Төлбөрийн гүйлгээний бүтэц

```javascript
// Firestore: businesses/{bizId}/transactions/{txnId}
{
  id: "txn_abc123",
  
  // Гүйлгээний төрөл
  type: "payment",                       // ← Доор 2.2-т бүх төрөл
  
  // Холбоос
  orderId: "ord_xyz",                    // Захиалгатай холбоотой
  orderNumber: "ORD-0042",              // Denormalized
  customerId: "cust_123",
  customerName: "Болд",
  
  // Мөнгөн дүн
  amount: 5000000,                       // Гүйлгээний дүн (заавал эерэг тоо)
  currency: "MNT",
  
  // Аль данс
  accountId: "pa_khan_1",               // Төлбөрийн данс
  accountName: "Хаан банк — Үндсэн",   // Denormalized
  accountType: "bank_khan",
  
  // Төлбөрийн арга (дансны төрөлтэй адил, гэхдээ нэг данс дээр олон арга байж болно)
  paymentMethod: "bank_transfer",        // ← Доор 2.3-т бүх арга
  
  // Баталгаажуулалт
  verification: {
    status: "verified",                  // "pending" | "verified" | "rejected"
    verifiedBy: "user_2",
    verifiedByName: "Дорж",
    verifiedAt: Timestamp,
    
    // Баримтын зураг (банкны шилжүүлгийн скриншот)
    receiptImage: "https://storage.../receipt.jpg",
    receiptNote: "Хаан банкнаас шилжүүлсэн",
    
    // Автомат таарц (ирээдүйд)
    bankReference: "TXN202602220001",    // Банкны лавлах дугаар
  },
  
  // Валют хөрвүүлэлт (хэрэв гадаад валют бол)
  exchange: {
    originalAmount: 1000,                // Эх дүн
    originalCurrency: "CNY",             // Юань
    exchangeRate: 480,                   // 1 CNY = 480 MNT
    convertedAmount: 480000              // MNT дүн
  },
  
  // Буцаалтын мэдээлэл (type === "refund" бол)
  refund: {
    originalTransactionId: "txn_orig",   // Аль гүйлгээг буцааж байгаа
    reason: "Бараа гэмтэлтэй",
    refundType: "full",                  // "full" | "partial"
  },
  
  // Тэмдэглэл
  note: "Урьдчилгаа төлсөн",
  internalNote: "Харилцагч утсаар мэдэгдсэн",
  
  // Мета
  createdBy: "user_1",
  createdByName: "Бат",
  createdAt: Timestamp,
  updatedAt: Timestamp,
  isDeleted: false
}
```

### 2.2 Гүйлгээний бүх төрлүүд

| # | Төрөл ID | Нэр | Чиглэл | Тайлбар |
|---|----------|-----|--------|---------|
| 1 | `payment` | Төлбөр | ➡️ Орлого | Харилцагчаас мөнгө авсан |
| 2 | `refund` | Буцаалт | ⬅️ Зарлага | Харилцагчид мөнгө буцаасан |
| 3 | `deposit` | Урьдчилгаа | ➡️ Орлого | Урьдчилж авсан мөнгө |
| 4 | `adjustment_add` | Тохируулга (+) | ➡️ | Тооцоо нэмэх (залруулга) |
| 5 | `adjustment_sub` | Тохируулга (-) | ⬅️ | Тооцоо хасах (залруулга) |
| 6 | `credit_payment` | Зээлийн төлбөр | ➡️ Орлого | Зээлтэй харилцагч төлбөр хийсэн |
| 7 | `write_off` | Хасалт | — | Авлага цуцлах (авч чадахгүй гэж үзсэн) |
| 8 | `transfer` | Данс хоорондын шилжүүлэг | ↔️ | Кассны мөнгийг банк руу тавьсан гэх мэт |

### 2.3 Төлбөрийн арга (Payment Methods)

| # | Арга ID | Нэр | Тайлбар |
|---|---------|-----|---------|
| 1 | `cash` | Бэлэн мөнгө | Гар дээр бэлнээр авсан |
| 2 | `bank_transfer` | Банкны шилжүүлэг | Дансаар шилжүүлсэн |
| 3 | `qpay` | QPay | QR кодоор төлсөн |
| 4 | `socialpay` | SocialPay | SocialPay-ээр төлсөн |
| 5 | `monpay` | MonPay | MonPay-ээр |
| 6 | `card` | Карт (POS) | POS терминалаар |
| 7 | `hipay` | HiPay (Хи) | Хи аппаар |
| 8 | `storepay` | StorePay | StorePay зээлээр |
| 9 | `lendmn` | LendMN | LendMN зээлээр |
| 10 | `wechat_pay` | WeChat Pay | WeChat Pay (Хятад хэрэглэгч) |
| 11 | `credit` | Зээлээр / Дараа төлнө | Харилцагч дараа төлнө |
| 12 | `other` | Бусад | Бусад арга |

### 2.4 Төлбөр бүртгэх дэлгэц (Modal)

```
┌──────────────────────────────────────────┐
│       💳 Төлбөр бүртгэх                  │
│       #ORD-0042 • Болд                   │
├──────────────────────────────────────────┤
│                                          │
│  Нийт дүн:        ₮8,555,000            │
│  Өмнө төлсөн:     ₮0                    │
│  Үлдэгдэл:       ₮8,555,000            │
│                                          │
│  ── Төлбөрийн мэдээлэл ────────────── │
│                                          │
│  Төлбөрийн дүн: *                        │
│  ┌────────────────────────────────────┐  │
│  │ ₮ 5,000,000                       │  │
│  └────────────────────────────────────┘  │
│  [Бүгдийг төлөх ₮8,555,000]             │
│                                          │
│  Төлбөрийн арга: *                       │
│  ┌────────────────────────────────────┐  │
│  │ 💵 Бэлэн мөнгө                   │  │
│  │ 🏦 Банкны шилжүүлэг       ← сонгосон│
│  │ 📱 QPay                           │  │
│  │ 📱 SocialPay                      │  │
│  │ 📱 MonPay                         │  │
│  │ 💳 Карт (POS)                     │  │
│  │ 📱 Бусад...                       │  │
│  └────────────────────────────────────┘  │
│                                          │
│  Хүлээн авсан данс: *                    │
│  ┌────────────────────────────────────┐  │
│  │ 🏦 Хаан банк — Үндсэн    ← сонгосон│
│  │ 🏦 Голомт банк — Нэмэлт           │  │
│  └────────────────────────────────────┘  │
│  (Арга сонгоход тохирох данс шүүгдэнэ) │
│                                          │
│  Баримтын зураг: (заавал биш)            │
│  ┌──────┐                                │
│  │  📷  │  [Зураг хавсаргах]            │
│  │      │                                │
│  └──────┘                                │
│                                          │
│  Тэмдэглэл: (заавал биш)                │
│  ┌────────────────────────────────────┐  │
│  │ Урьдчилгаа төлсөн                 │  │
│  └────────────────────────────────────┘  │
│                                          │
│  Огноо:                                  │
│  ┌────────────────────────────────────┐  │
│  │ 📅 2026.02.22              ← Өнөөдөр│
│  └────────────────────────────────────┘  │
│  (Өчигдрийн төлбөр бүртгэж болно)       │
│                                          │
│  [     💰 Төлбөр бүртгэх     ]          │
│  [     Цуцлах                  ]          │
│                                          │
└──────────────────────────────────────────┘
```

### 2.5 Хуваан төлөх (Split Payment) — Нэг захиалга, олон арга

```
Жишээ: Харилцагч ₮8,555,000-ийн захиалгыг:
  → ₮5,000,000 банкны шилжүүлгээр (Хаан банк)
  → ₮3,000,000 QPay-ээр
  → ₮555,000 бэлнээр
  = 3 transaction үүснэ, тус тусдаа данстай

Дэлгэц:
┌──────────────────────────────────────────┐
│  💳 Хуваан төлөх                         │
│                                          │
│  Нийт: ₮8,555,000                       │
│                                          │
│  Төлбөр 1:                               │
│  ₮ [5,000,000] • [🏦 Банк шилж.▾]       │
│  Данс: [Хаан банк — Үндсэн ▾]           │
│                                          │
│  Төлбөр 2:                               │
│  ₮ [3,000,000] • [📱 QPay ▾]            │
│  Данс: [QPay ▾]                          │
│                                          │
│  Төлбөр 3:                               │
│  ₮ [  555,000] • [💵 Бэлэн ▾]           │
│  Данс: [Касс ▾]                          │
│                                          │
│  [+ Дахиж нэмэх]                        │
│                                          │
│  Нийт: ₮8,555,000 ✅ Таарч байна        │
│                                          │
│  [     💰 Бүгдийг бүртгэх     ]          │
└──────────────────────────────────────────┘
```

---

## 3. 🔙 БУЦААЛТ (Refunds)

### 3.1 Буцаалтын төрлүүд

| # | Төрөл | Тайлбар |
|---|-------|---------|
| 1 | **Бүрэн буцаалт** | Захиалгын бүх дүнг буцаана |
| 2 | **Хэсэгчлэн буцаалт** | Зөвхөн тодорхой дүнг буцаана |
| 3 | **Барааны буцаалт** | Тодорхой бараануудыг буцаана (тоо, дүн автомат) |
| 4 | **Хөнгөлөлт буцаалт** | Хөнгөлөлт нэмж өгөх (мөнгө буцаахгүй, дараагийн захиалгад) |
| 5 | **Кредит буцаалт** | Харилцагчийн балансад нэмэх (дараа ашиглах) |

### 3.2 Буцаалтын мэдээллийн бүтэц

```javascript
// Firestore: businesses/{bizId}/transactions/{txnId} (type === "refund")
{
  id: "txn_refund_001",
  type: "refund",
  
  orderId: "ord_xyz",
  orderNumber: "ORD-0042",
  customerId: "cust_123",
  customerName: "Болд",
  
  amount: 4500000,                       // Буцаасан дүн
  
  // ⚠️ АЛЬ ДАНСНААС буцаасан
  accountId: "pa_khan_1",               // Хаан банкны данснаас
  accountName: "Хаан банк — Үндсэн",
  
  // Буцаалтын дэлгэрэнгүй
  refund: {
    originalTransactionId: "txn_abc123", // Анхны төлбөрийн гүйлгээ
    reason: "defective",                 // Шалтгааны код (доор 3.3-т)
    reasonText: "Бараа гэмтэлтэй байсан",
    refundType: "partial",               // "full" | "partial" | "item"
    
    // Барааны буцаалт бол:
    refundedItems: [
      {
        productId: "prod_123",
        name: "iPhone 15 Pro",
        quantity: 1,                     // 2-оос 1-ийг буцаасан
        unitPrice: 4500000,
        refundAmount: 4500000
      }
    ],
    
    // Буцаасан арга
    refundMethod: "same_account",        // "same_account" | "different_account" | "credit"
    // same_account: Анхны төлбөр хийсэн данс руу буцаана
    // different_account: Өөр данс руу буцаана
    // credit: Харилцагчийн балансад нэмнэ
    
    // Нөөц буцаалт
    restockItems: true,                  // Нөөцөд буцааж нэмэх үү
  },
  
  // Баталгаажуулалт
  verification: {
    status: "verified",
    approvedBy: "user_owner",           // Буцаалтыг хэн зөвшөөрсөн
    approvedByName: "Бат-Эрдэнэ",
    approvedAt: Timestamp,
    receiptImage: "https://...",        // Шилжүүлгийн баримт
  },
  
  note: "Дэлгэц гэмтэлтэй, харилцагч буцаалт хүссэн",
  createdBy: "user_2",
  createdAt: Timestamp
}
```

### 3.3 Буцаалтын шалтгаанууд

| # | Код | Нэр (MN) |
|---|-----|----------|
| 1 | `defective` | Бараа гэмтэлтэй |
| 2 | `wrong_item` | Буруу бараа илгээсэн |
| 3 | `not_as_described` | Тайлбартай зөрүүтэй |
| 4 | `customer_changed_mind` | Харилцагч бодлоо өөрчилсөн |
| 5 | `duplicate_order` | Давхардсан захиалга |
| 6 | `late_delivery` | Хугацаа хоцорсон |
| 7 | `overcharge` | Илүү төлбөр авсан |
| 8 | `order_cancelled` | Захиалга цуцалсан |
| 9 | `other` | Бусад шалтгаан |

### 3.4 Буцаалт хийх дэлгэц

```
┌──────────────────────────────────────────┐
│       🔙 Буцаалт хийх                    │
│       #ORD-0042 • Болд                   │
├──────────────────────────────────────────┤
│                                          │
│  Нийт дүн:     ₮8,555,000               │
│  Төлсөн дүн:   ₮8,555,000               │
│  Өмнө буцаасан: ₮0                      │
│  Буцаах боломжтой: ₮8,555,000           │
│                                          │
│  ── Буцаалтын төрөл ────────────────── │
│  (●) Хэсэгчлэн буцаалт                 │
│  ( ) Бүрэн буцаалт                      │
│  ( ) Барааны буцаалт                     │
│                                          │
│  ── Буцаах дүн ──────────────────────── │
│  ┌────────────────────────────────────┐  │
│  │ ₮ 4,500,000                       │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ── Шалтгаан * ──────────────────────── │
│  ┌────────────────────────────────────┐  │
│  │ ▾ Бараа гэмтэлтэй               │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ Нэмэлт тайлбар...                │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ── Аль данснаас буцаах * ─────────── │
│                                          │
│  Анхны төлбөр:                           │
│  • ₮5,000,000 — Хаан банк (банк шилж.)  │
│  • ₮3,000,000 — QPay                    │
│  • ₮  555,000 — Касс (бэлэн)            │
│                                          │
│  Буцаах данс:                            │
│  (●) Анхны данс руу буцаах              │
│      (₮4,500,000 → Хаан банк)           │
│  ( ) Өөр данс сонгох                    │
│  ( ) Харилцагчийн балансад нэмэх        │
│                                          │
│  ── Нөөц ────────────────────────────── │
│  ☑️ Буцаасан барааг нөөцөд нэмэх        │
│                                          │
│  ── Баримт ──────────────────────────── │
│  [📷 Баримтын зураг хавсаргах]          │
│                                          │
│  ⚠️ Буцаалт хийхэд PIN шаардлагатай    │
│                                          │
│  [     🔙 Буцаалт хийх      ]           │
│  [     Цуцлах                 ]           │
└──────────────────────────────────────────┘
```

---

## 4. 📊 ЗАХИАЛГЫН ТӨЛБӨРИЙН ТОЙМ

### 4.1 Захиалгын дэлгэрэнгүй дэх "Төлбөр" tab

```
┌──────────────────────────────────────────┐
│  #ORD-0042 • Болд                        │
│  [Мэдээлэл] [Бараа] [💰 Төлбөр] [Түүх]  │
├──────────────────────────────────────────┤
│                                          │
│  ── Тооцоо ──────────────────────────── │
│  Барааны дүн:       ₮9,000,000          │
│  Хөнгөлөлт (5%):   -₮450,000           │
│  Хүргэлтийн төлбөр: +₮5,000            │
│  Гаалийн татвар:    +₮200,000           │
│  ────────────────────────────            │
│  НИЙТ:              ₮8,755,000          │
│                                          │
│  ── Төлбөрийн мэдээлэл ─────────────── │
│  Нийт төлсөн:       ₮7,000,000 🟡       │
│  Буцаалт:           -₮0                 │
│  Үлдэгдэл:         ₮1,755,000          │
│  Төлөв:             🟡 Хэсэгчлэн төлсөн│
│                                          │
│  ── Гүйлгээний түүх ────────────────── │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │ ➡️ 02.20 15:30                    │  │
│  │ ₮5,000,000 • Банкны шилжүүлэг    │  │
│  │ 🏦 Хаан банк — Үндсэн            │  │
│  │ ✅ Баталгаажсан • Бат             │  │
│  │ 📎 receipt.jpg                    │  │
│  │ "Урьдчилгаа"                      │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │ ➡️ 02.21 10:15                    │  │
│  │ ₮2,000,000 • Бэлэн мөнгө        │  │
│  │ 💵 Касс                          │  │
│  │ ✅ Баталгаажсан • Дорж            │  │
│  │ "Бэлнээр авсан"                   │  │
│  └────────────────────────────────────┘  │
│                                          │
│  [+ 💳 Төлбөр бүртгэх]                 │
│  [  🔙 Буцаалт хийх  ]                 │
│                                          │
└──────────────────────────────────────────┘
```

---

## 5. 📈 АВЛАГА / ӨГЛӨГ УДИРДЛАГА (Бөөний бизнест)

### 5.1 Харилцагчийн тооцооны дэлгэц

```
┌──────────────────────────────────────────┐
│  👤 Болд — Тооцооны хуудас               │
├──────────────────────────────────────────┤
│                                          │
│  ┌──────────┐ ┌──────────┐              │
│  │ Нийт     │ │ Авлага   │              │
│  │ захиалга │ │ (өртэй)  │              │
│  │ 25       │ │₮1,755,000│              │
│  │          │ │ 🔴       │              │
│  └──────────┘ └──────────┘              │
│                                          │
│  ── Төлөгдөөгүй захиалгууд ──────────  │
│  ┌────────────────────────────────────┐  │
│  │ #ORD-0042  ₮8,755,000             │  │
│  │ Төлсөн: ₮7,000,000               │  │
│  │ Үлдэгдэл: ₮1,755,000 (20 хоног)  │  │
│  │ ⚠️ Хугацаа хэтэрсэн              │  │
│  │ [💳 Төлбөр бүртгэх]              │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ── Сүүлийн гүйлгээнүүд ────────────── │
│  02.21 ➡️ ₮2,000,000 Бэлэн → #0042    │
│  02.20 ➡️ ₮5,000,000 Банк → #0042     │
│  02.15 ➡️ ₮3,200,000 QPay → #0041     │
│  02.10 ⬅️ ₮500,000 Буцаалт → #0038    │
│  ...                                     │
│  [Бүгд харах →]                          │
│                                          │
│  ── Тооцооны нэгтгэл ──────────────── │
│  Нийт худалдан авалт: ₮45,000,000      │
│  Нийт төлсөн:        ₮43,245,000      │
│  Нийт буцаалт:       -₮500,000        │
│  Одоогийн авлага:     ₮1,755,000       │
│                                          │
│  ── Зээлийн мэдээлэл (бөөний) ────── │
│  Зээлийн хязгаар:    ₮5,000,000       │
│  Ашигласан:          ₮1,755,000       │
│  Үлдсэн:            ₮3,245,000       │
│  ████████░░░░░░░░░░░ 35%               │
│                                          │
│  [📄 Тооцооны хуудас PDF татах]         │
│  [📤 Тооцооны мэдэгдэл илгээх]         │
└──────────────────────────────────────────┘
```

### 5.2 Авлагын нэгтгэл Dashboard (Бөөний)

```
┌──────────────────────────────────────────┐
│  📊 Dashboard > Авлага                   │
│                                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐│
│  │ Нийт     │ │ Хугацаанд│ │ Хэтэрсэн ││
│  │ авлага   │ │ байгаа   │ │ авлага   ││
│  │₮12.5 сая │ │₮8.2 сая  │ │₮4.3 сая  ││
│  └──────────┘ └──────────┘ └──────────┘│
│                                          │
│  ── Насжилтаар (Aging) ─────────────── │
│  0-7 хоног:   ₮3,200,000  ████████     │
│  8-14 хоног:  ₮2,500,000  ██████       │
│  15-30 хоног: ₮2,500,000  ██████       │
│  31-60 хоног: ₮3,000,000  ███████ ⚠️   │
│  60+ хоног:   ₮1,300,000  ███ 🔴       │
│                                          │
│  ── Хамгийн их авлагатай харилцагч ──  │
│  1. Болд     ₮1,755,000 (20 хоног)     │
│  2. Дорж     ₮1,500,000 (45 хоног) ⚠️  │
│  3. Оюуна    ₮1,200,000 (5 хоног)      │
└──────────────────────────────────────────┘
```

---

## 6. 💱 ВАЛЮТ & ХАНШ (Карго бизнест)

### 6.1 Валютын тохиргоо

```javascript
// businesses/{bizId} → settings.currencies
{
  currencies: {
    primary: "MNT",                      // Үндсэн валют
    supported: ["MNT", "CNY", "USD", "KRW", "EUR"],
    exchangeRates: {
      "CNY": { rate: 480, lastUpdated: Timestamp },
      "USD": { rate: 3420, lastUpdated: Timestamp },
      "KRW": { rate: 2.6, lastUpdated: Timestamp },
      "EUR": { rate: 3700, lastUpdated: Timestamp }
    },
    autoUpdate: false                    // Ирээдүйд: автомат ханш шинэчлэх
  }
}
```

### 6.2 Валют хөрвүүлэлтийн дэлгэц

```
Захиалга үүсгэхэд (Карго):
┌────────────────────────────────────┐
│ Барааны үнэ:                       │
│ [¥ 1,000 CNY] × ₮480 = ₮480,000  │
│                                    │
│ Ханш: 1 CNY = ₮[480]  [🔄 Шинэчлэх]│
│                                    │
│ Ашгийн нэмэгдэл: [20]%            │
│ = ₮480,000 × 1.20 = ₮576,000     │
│                                    │
│ Дугуйлах: ₮576,000 → ₮576,000    │
│ (мянгат руу дугуйлах)             │
└────────────────────────────────────┘
```

---

## 7. 📊 САНХҮҮГИЙН ТАЙЛАН

### 7.1 Тайлангийн төрлүүд

| # | Тайлан | Агуулга | Эрх |
|---|--------|---------|-----|
| 1 | **Орлогын тайлан** | Нийт орлого, дансаар задалсан | reports.view_revenue |
| 2 | **Төлбөрийн аргаар** | QPay, банк, бэлэн тус тусад нь | reports.view_revenue |
| 3 | **Дансны хөдөлгөөн** | Тухайн дансны бүх гүйлгээ | reports.view_revenue |
| 4 | **Авлагын тайлан** | Хэнд хэдий төлөгдөөгүй | reports.view_revenue |
| 5 | **Буцаалтын тайлан** | Буцаалтын нэгтгэл, шалтгаанаар | reports.view_revenue |
| 6 | **Ашгийн тайлан** | Борлуулалт - Өртөг = Ашиг | reports.view_revenue |
| 7 | **Мөнгөн урсгал** | Орлого vs Зарлага (cashflow) | reports.view_revenue |
| 8 | **Харилцагчийн тооцоо** | Тухайн харилцагчийн бүх гүйлгээ | reports.view_revenue |

### 7.2 Дансны хөдөлгөөн тайлан

```
┌──────────────────────────────────────────┐
│  📊 Тайлан > Дансны хөдөлгөөн            │
│                                          │
│  Данс: [🏦 Хаан банк — Үндсэн ▾]       │
│  Хугацаа: [02.01] — [02.22]             │
│                                          │
│  Эхний үлдэгдэл:    ₮8,500,000         │
│  + Орлого:           ₮15,200,000        │
│  - Зарлага (буцаалт):- ₮1,500,000      │
│  Эцсийн үлдэгдэл:   ₮22,200,000       │
│                                          │
│  ── Гүйлгээнүүд ────────────────────── │
│  Огноо  │ Тайлбар          │   Дүн     │
│  ──────┼──────────────────┼───────────│
│  02.22  │ #0042 Болд      │ +₮5,000,000│
│  02.21  │ #0042 Болд      │ +₮2,000,000│
│  02.20  │ #0041 Буцаалт   │ -₮500,000  │
│  02.19  │ #0040 Дорж      │ +₮3,200,000│
│  ...                                    │
│                                          │
│  [📥 Excel татах]  [📄 PDF татах]       │
└──────────────────────────────────────────┘
```

### 7.3 Төлбөрийн аргаар нэгтгэл

```
┌──────────────────────────────────────────┐
│  📊 Энэ сарын орлого — Аргаар            │
│                                          │
│  💵 Бэлэн мөнгө:     ₮8,500,000  (28%)│
│  ████████████████░░░░░░                  │
│                                          │
│  🏦 Банкны шилжүүлэг: ₮12,300,000 (40%)│
│  ████████████████████████░░              │
│                                          │
│  📱 QPay:             ₮5,200,000  (17%)│
│  ██████████░░░░░░░░░░░░                  │
│                                          │
│  📱 SocialPay:        ₮2,800,000  (9%) │
│  █████░░░░░░░░░░░░░░░░                   │
│                                          │
│  💳 Карт:             ₮1,200,000  (4%) │
│  ██░░░░░░░░░░░░░░░░░░░                   │
│                                          │
│  📱 Бусад:            ₮700,000   (2%) │
│  █░░░░░░░░░░░░░░░░░░░░                   │
│                                          │
│  НИЙТ:               ₮30,700,000       │
└──────────────────────────────────────────┘
```

---

## 8. 🔐 ЭРХҮҮД (Төлбөр тооцоонд хамаарах)

| Эрхийн ID | Нэр | Тайлбар |
|-----------|-----|---------|
| `orders.manage_payments` | Төлбөр бүртгэх | Төлбөр нэмэх, баталгаажуулах |
| `orders.process_refund` | Буцаалт хийх | Буцаалт боловсруулах |
| `orders.view_financials` | Мөнгөн дүн харах | Үнэ, төлбөр, ашиг |
| `reports.view_revenue` | Орлогын тайлан | Санхүүгийн бүх тайлан |
| `settings.manage_accounts` | Данс удирдах | Төлбөрийн данс нэмэх/засах |
| `settings.manage_currencies` | Валют удирдах | Ханш тохируулах |

---

## 9. 📱 МЭДЭГДЛҮҮД (Төлбөр тооцоонд)

| # | Мэдэгдэл | Хэзээ | Хэнд |
|---|----------|-------|------|
| 1 | Төлбөр бүртгэгдлээ | Төлбөр нэмэхэд | receive_payment эрхтэй |
| 2 | Захиалга бүрэн төлөгдлөө | paymentStatus → "paid" | receive_payment |
| 3 | Буцаалт хийгдлээ | Буцаалт боловсруулахад | receive_payment |
| 4 | Авлага хугацаа хэтрэх гэж байна | 3 хоног үлдсэн | receive_payment |
| 5 | Авлага хугацаа хэтэрсэн | Хугацаа дууссан | receive_payment |
| 6 | Зээлийн хязгаар хэтрэх гэж байна | 80% ашигласан | receive_payment |

---

*Энэ баримт бичиг DETAILED_PLAN.md, DETAILED_PLAN_PART2.md-тэй хамт бүрэн дүр зургийг гаргана.*
